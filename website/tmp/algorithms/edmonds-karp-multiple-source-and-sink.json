{
  "slug": "edmonds-karp-multiple-source-and-sink",
  "name": "Edmonds Karp Multiple Source and Sink",
  "categories": ["graphs"],
  "body": {},
  "implementations": {
    "python": {
      "dir": "graphs/edmonds_karp_multiple_source_and_sink.py",
      "url": "https://github.com/TheAlgorithms/python/tree/master/graphs/edmonds_karp_multiple_source_and_sink.py",
      "code": "<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FlowNetwork</span>:\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, graph, sources, sinks</span>):\n        self.sourceIndex = <span class=\"hljs-literal\">None</span>\n        self.sinkIndex = <span class=\"hljs-literal\">None</span>\n        self.graph = graph\n\n        self._normalizeGraph(sources, sinks)\n        self.verticesCount = <span class=\"hljs-built_in\">len</span>(graph)\n        self.maximumFlowAlgorithm = <span class=\"hljs-literal\">None</span>\n\n    <span class=\"hljs-comment\"># make only one source and one sink</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_normalizeGraph</span>(<span class=\"hljs-params\">self, sources, sinks</span>):\n        <span class=\"hljs-keyword\">if</span> sources <span class=\"hljs-keyword\">is</span> <span class=\"hljs-built_in\">int</span>:\n            sources = [sources]\n        <span class=\"hljs-keyword\">if</span> sinks <span class=\"hljs-keyword\">is</span> <span class=\"hljs-built_in\">int</span>:\n            sinks = [sinks]\n\n        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(sources) == <span class=\"hljs-number\">0</span> <span class=\"hljs-keyword\">or</span> <span class=\"hljs-built_in\">len</span>(sinks) == <span class=\"hljs-number\">0</span>:\n            <span class=\"hljs-keyword\">return</span>\n\n        self.sourceIndex = sources[<span class=\"hljs-number\">0</span>]\n        self.sinkIndex = sinks[<span class=\"hljs-number\">0</span>]\n\n        <span class=\"hljs-comment\"># make fake vertex if there are more</span>\n        <span class=\"hljs-comment\"># than one source or sink</span>\n        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">len</span>(sources) &gt; <span class=\"hljs-number\">1</span> <span class=\"hljs-keyword\">or</span> <span class=\"hljs-built_in\">len</span>(sinks) &gt; <span class=\"hljs-number\">1</span>:\n            maxInputFlow = <span class=\"hljs-number\">0</span>\n            <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> sources:\n                maxInputFlow += <span class=\"hljs-built_in\">sum</span>(self.graph[i])\n\n            size = <span class=\"hljs-built_in\">len</span>(self.graph) + <span class=\"hljs-number\">1</span>\n            <span class=\"hljs-keyword\">for</span> room <span class=\"hljs-keyword\">in</span> self.graph:\n                room.insert(<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>)\n            self.graph.insert(<span class=\"hljs-number\">0</span>, [<span class=\"hljs-number\">0</span>] * size)\n            <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> sources:\n                self.graph[<span class=\"hljs-number\">0</span>][i + <span class=\"hljs-number\">1</span>] = maxInputFlow\n            self.sourceIndex = <span class=\"hljs-number\">0</span>\n\n            size = <span class=\"hljs-built_in\">len</span>(self.graph) + <span class=\"hljs-number\">1</span>\n            <span class=\"hljs-keyword\">for</span> room <span class=\"hljs-keyword\">in</span> self.graph:\n                room.append(<span class=\"hljs-number\">0</span>)\n            self.graph.append([<span class=\"hljs-number\">0</span>] * size)\n            <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> sinks:\n                self.graph[i + <span class=\"hljs-number\">1</span>][size - <span class=\"hljs-number\">1</span>] = maxInputFlow\n            self.sinkIndex = size - <span class=\"hljs-number\">1</span>\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">findMaximumFlow</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">if</span> self.maximumFlowAlgorithm <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span>:\n            <span class=\"hljs-keyword\">raise</span> Exception(<span class=\"hljs-string\">&quot;You need to set maximum flow algorithm before.&quot;</span>)\n        <span class=\"hljs-keyword\">if</span> self.sourceIndex <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span> <span class=\"hljs-keyword\">or</span> self.sinkIndex <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span>:\n            <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">0</span>\n\n        self.maximumFlowAlgorithm.execute()\n        <span class=\"hljs-keyword\">return</span> self.maximumFlowAlgorithm.getMaximumFlow()\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">setMaximumFlowAlgorithm</span>(<span class=\"hljs-params\">self, Algorithm</span>):\n        self.maximumFlowAlgorithm = Algorithm(self)\n\n\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FlowNetworkAlgorithmExecutor</span>:\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, flowNetwork</span>):\n        self.flowNetwork = flowNetwork\n        self.verticesCount = flowNetwork.verticesCount\n        self.sourceIndex = flowNetwork.sourceIndex\n        self.sinkIndex = flowNetwork.sinkIndex\n        <span class=\"hljs-comment\"># it&#x27;s just a reference, so you shouldn&#x27;t change</span>\n        <span class=\"hljs-comment\"># it in your algorithms, use deep copy before doing that</span>\n        self.graph = flowNetwork.graph\n        self.executed = <span class=\"hljs-literal\">False</span>\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">execute</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> self.executed:\n            self._algorithm()\n            self.executed = <span class=\"hljs-literal\">True</span>\n\n    <span class=\"hljs-comment\"># You should override it</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_algorithm</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">pass</span>\n\n\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">MaximumFlowAlgorithmExecutor</span>(<span class=\"hljs-title class_ inherited__\">FlowNetworkAlgorithmExecutor</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, flowNetwork</span>):\n        <span class=\"hljs-built_in\">super</span>().__init__(flowNetwork)\n        <span class=\"hljs-comment\"># use this to save your result</span>\n        self.maximumFlow = -<span class=\"hljs-number\">1</span>\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">getMaximumFlow</span>(<span class=\"hljs-params\">self</span>):\n        <span class=\"hljs-keyword\">if</span> <span class=\"hljs-keyword\">not</span> self.executed:\n            <span class=\"hljs-keyword\">raise</span> Exception(<span class=\"hljs-string\">&quot;You should execute algorithm before using its result!&quot;</span>)\n\n        <span class=\"hljs-keyword\">return</span> self.maximumFlow\n\n\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">PushRelabelExecutor</span>(<span class=\"hljs-title class_ inherited__\">MaximumFlowAlgorithmExecutor</span>):\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">self, flowNetwork</span>):\n        <span class=\"hljs-built_in\">super</span>().__init__(flowNetwork)\n\n        self.preflow = [[<span class=\"hljs-number\">0</span>] * self.verticesCount <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.verticesCount)]\n\n        self.heights = [<span class=\"hljs-number\">0</span>] * self.verticesCount\n        self.excesses = [<span class=\"hljs-number\">0</span>] * self.verticesCount\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_algorithm</span>(<span class=\"hljs-params\">self</span>):\n        self.heights[self.sourceIndex] = self.verticesCount\n\n        <span class=\"hljs-comment\"># push some substance to graph</span>\n        <span class=\"hljs-keyword\">for</span> nextVertexIndex, bandwidth <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">enumerate</span>(self.graph[self.sourceIndex]):\n            self.preflow[self.sourceIndex][nextVertexIndex] += bandwidth\n            self.preflow[nextVertexIndex][self.sourceIndex] -= bandwidth\n            self.excesses[nextVertexIndex] += bandwidth\n\n        <span class=\"hljs-comment\"># Relabel-to-front selection rule</span>\n        verticesList = [\n            i\n            <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.verticesCount)\n            <span class=\"hljs-keyword\">if</span> i != self.sourceIndex <span class=\"hljs-keyword\">and</span> i != self.sinkIndex\n        ]\n\n        <span class=\"hljs-comment\"># move through list</span>\n        i = <span class=\"hljs-number\">0</span>\n        <span class=\"hljs-keyword\">while</span> i &lt; <span class=\"hljs-built_in\">len</span>(verticesList):\n            vertexIndex = verticesList[i]\n            previousHeight = self.heights[vertexIndex]\n            self.processVertex(vertexIndex)\n            <span class=\"hljs-keyword\">if</span> self.heights[vertexIndex] &gt; previousHeight:\n                <span class=\"hljs-comment\"># if it was relabeled, swap elements</span>\n                <span class=\"hljs-comment\"># and start from 0 index</span>\n                verticesList.insert(<span class=\"hljs-number\">0</span>, verticesList.pop(i))\n                i = <span class=\"hljs-number\">0</span>\n            <span class=\"hljs-keyword\">else</span>:\n                i += <span class=\"hljs-number\">1</span>\n\n        self.maximumFlow = <span class=\"hljs-built_in\">sum</span>(self.preflow[self.sourceIndex])\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">processVertex</span>(<span class=\"hljs-params\">self, vertexIndex</span>):\n        <span class=\"hljs-keyword\">while</span> self.excesses[vertexIndex] &gt; <span class=\"hljs-number\">0</span>:\n            <span class=\"hljs-keyword\">for</span> neighbourIndex <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.verticesCount):\n                <span class=\"hljs-comment\"># if it&#x27;s neighbour and current vertex is higher</span>\n                <span class=\"hljs-keyword\">if</span> (\n                    self.graph[vertexIndex][neighbourIndex]\n                    - self.preflow[vertexIndex][neighbourIndex]\n                    &gt; <span class=\"hljs-number\">0</span>\n                    <span class=\"hljs-keyword\">and</span> self.heights[vertexIndex] &gt; self.heights[neighbourIndex]\n                ):\n                    self.push(vertexIndex, neighbourIndex)\n\n            self.relabel(vertexIndex)\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">push</span>(<span class=\"hljs-params\">self, fromIndex, toIndex</span>):\n        preflowDelta = <span class=\"hljs-built_in\">min</span>(\n            self.excesses[fromIndex],\n            self.graph[fromIndex][toIndex] - self.preflow[fromIndex][toIndex],\n        )\n        self.preflow[fromIndex][toIndex] += preflowDelta\n        self.preflow[toIndex][fromIndex] -= preflowDelta\n        self.excesses[fromIndex] -= preflowDelta\n        self.excesses[toIndex] += preflowDelta\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">relabel</span>(<span class=\"hljs-params\">self, vertexIndex</span>):\n        minHeight = <span class=\"hljs-literal\">None</span>\n        <span class=\"hljs-keyword\">for</span> toIndex <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.verticesCount):\n            <span class=\"hljs-keyword\">if</span> (\n                self.graph[vertexIndex][toIndex] - self.preflow[vertexIndex][toIndex]\n                &gt; <span class=\"hljs-number\">0</span>\n            ):\n                <span class=\"hljs-keyword\">if</span> minHeight <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span> <span class=\"hljs-keyword\">or</span> self.heights[toIndex] &lt; minHeight:\n                    minHeight = self.heights[toIndex]\n\n        <span class=\"hljs-keyword\">if</span> minHeight <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-literal\">None</span>:\n            self.heights[vertexIndex] = minHeight + <span class=\"hljs-number\">1</span>\n\n\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&quot;__main__&quot;</span>:\n    entrances = [<span class=\"hljs-number\">0</span>]\n    exits = [<span class=\"hljs-number\">3</span>]\n    <span class=\"hljs-comment\"># graph = [</span>\n    <span class=\"hljs-comment\">#     [0, 0, 4, 6, 0, 0],</span>\n    <span class=\"hljs-comment\">#     [0, 0, 5, 2, 0, 0],</span>\n    <span class=\"hljs-comment\">#     [0, 0, 0, 0, 4, 4],</span>\n    <span class=\"hljs-comment\">#     [0, 0, 0, 0, 6, 6],</span>\n    <span class=\"hljs-comment\">#     [0, 0, 0, 0, 0, 0],</span>\n    <span class=\"hljs-comment\">#     [0, 0, 0, 0, 0, 0],</span>\n    <span class=\"hljs-comment\"># ]</span>\n    graph = [[<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">7</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>], [<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">6</span>, <span class=\"hljs-number\">0</span>], [<span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">8</span>], [<span class=\"hljs-number\">9</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>, <span class=\"hljs-number\">0</span>]]\n\n    <span class=\"hljs-comment\"># prepare our network</span>\n    flowNetwork = FlowNetwork(graph, entrances, exits)\n    <span class=\"hljs-comment\"># set algorithm</span>\n    flowNetwork.setMaximumFlowAlgorithm(PushRelabelExecutor)\n    <span class=\"hljs-comment\"># and calculate</span>\n    maximumFlow = flowNetwork.findMaximumFlow()\n\n    <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">f&quot;maximum flow is <span class=\"hljs-subst\">{maximumFlow}</span>&quot;</span>)\n"
    }
  },
  "contributors": [
    {
      "name": "Christian Clauss",
      "email": "cclauss@me.com",
      "commits": 1
    },
    {
      "name": "GeorgeChambi",
      "email": "charalambous99@gmail.com",
      "commits": 1
    },
    {
      "name": "William Zhang",
      "email": "39932068+WilliamHYZhang@users.noreply.github.com",
      "commits": 1
    },
    {
      "name": "Viraat Das",
      "email": "viraat.laldas@gmail.com",
      "commits": 1
    }
  ],
  "explanationUrl": {}
}
