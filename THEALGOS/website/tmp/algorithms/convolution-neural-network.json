{
  "slug": "convolution-neural-network",
  "name": "Convolution Neural Network",
  "categories": ["neuralnetwork"],
  "body": {},
  "implementations": {
    "python": {
      "dir": "neural_network/convolution_neural_network.py",
      "url": "https://github.com/TheAlgorithms/python/tree/master/neural_network/convolution_neural_network.py",
      "code": "<span class=\"hljs-string\">&quot;&quot;&quot;\n     - - - - - -- - - - - - - - - - - - - - - - - - - - - - -\n    Name - - CNN - Convolution Neural Network For Photo Recognizing\n    Goal - - Recognize Handing Writing Word Photo\n    Detail：Total 5 layers neural network\n            * Convolution layer\n            * Pooling layer\n            * Input layer layer of BP\n            * Hidden layer of BP\n            * Output layer of BP\n    Author: Stephen Lee\n    Github: 245885195@qq.com\n    Date: 2017.9.20\n    - - - - - -- - - - - - - - - - - - - - - - - - - - - - -\n&quot;&quot;&quot;</span>\n<span class=\"hljs-keyword\">import</span> pickle\n\n<span class=\"hljs-keyword\">import</span> numpy <span class=\"hljs-keyword\">as</span> np\n<span class=\"hljs-keyword\">from</span> matplotlib <span class=\"hljs-keyword\">import</span> pyplot <span class=\"hljs-keyword\">as</span> plt\n\n\n<span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">CNN</span>:\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">__init__</span>(<span class=\"hljs-params\">\n        self, conv1_get, size_p1, bp_num1, bp_num2, bp_num3, rate_w=<span class=\"hljs-number\">0.2</span>, rate_t=<span class=\"hljs-number\">0.2</span>\n    </span>):\n        <span class=\"hljs-string\">&quot;&quot;&quot;\n        :param conv1_get: [a,c,d]，size, number, step of convolution kernel\n        :param size_p1: pooling size\n        :param bp_num1: units number of flatten layer\n        :param bp_num2: units number of hidden layer\n        :param bp_num3: units number of output layer\n        :param rate_w: rate of weight learning\n        :param rate_t: rate of threshold learning\n        &quot;&quot;&quot;</span>\n        self.num_bp1 = bp_num1\n        self.num_bp2 = bp_num2\n        self.num_bp3 = bp_num3\n        self.conv1 = conv1_get[:<span class=\"hljs-number\">2</span>]\n        self.step_conv1 = conv1_get[<span class=\"hljs-number\">2</span>]\n        self.size_pooling1 = size_p1\n        self.rate_weight = rate_w\n        self.rate_thre = rate_t\n        self.w_conv1 = [\n            np.mat(-<span class=\"hljs-number\">1</span> * np.random.rand(self.conv1[<span class=\"hljs-number\">0</span>], self.conv1[<span class=\"hljs-number\">0</span>]) + <span class=\"hljs-number\">0.5</span>)\n            <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.conv1[<span class=\"hljs-number\">1</span>])\n        ]\n        self.wkj = np.mat(-<span class=\"hljs-number\">1</span> * np.random.rand(self.num_bp3, self.num_bp2) + <span class=\"hljs-number\">0.5</span>)\n        self.vji = np.mat(-<span class=\"hljs-number\">1</span> * np.random.rand(self.num_bp2, self.num_bp1) + <span class=\"hljs-number\">0.5</span>)\n        self.thre_conv1 = -<span class=\"hljs-number\">2</span> * np.random.rand(self.conv1[<span class=\"hljs-number\">1</span>]) + <span class=\"hljs-number\">1</span>\n        self.thre_bp2 = -<span class=\"hljs-number\">2</span> * np.random.rand(self.num_bp2) + <span class=\"hljs-number\">1</span>\n        self.thre_bp3 = -<span class=\"hljs-number\">2</span> * np.random.rand(self.num_bp3) + <span class=\"hljs-number\">1</span>\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">save_model</span>(<span class=\"hljs-params\">self, save_path</span>):\n        <span class=\"hljs-comment\"># save model dict with pickle</span>\n        model_dic = {\n            <span class=\"hljs-string\">&quot;num_bp1&quot;</span>: self.num_bp1,\n            <span class=\"hljs-string\">&quot;num_bp2&quot;</span>: self.num_bp2,\n            <span class=\"hljs-string\">&quot;num_bp3&quot;</span>: self.num_bp3,\n            <span class=\"hljs-string\">&quot;conv1&quot;</span>: self.conv1,\n            <span class=\"hljs-string\">&quot;step_conv1&quot;</span>: self.step_conv1,\n            <span class=\"hljs-string\">&quot;size_pooling1&quot;</span>: self.size_pooling1,\n            <span class=\"hljs-string\">&quot;rate_weight&quot;</span>: self.rate_weight,\n            <span class=\"hljs-string\">&quot;rate_thre&quot;</span>: self.rate_thre,\n            <span class=\"hljs-string\">&quot;w_conv1&quot;</span>: self.w_conv1,\n            <span class=\"hljs-string\">&quot;wkj&quot;</span>: self.wkj,\n            <span class=\"hljs-string\">&quot;vji&quot;</span>: self.vji,\n            <span class=\"hljs-string\">&quot;thre_conv1&quot;</span>: self.thre_conv1,\n            <span class=\"hljs-string\">&quot;thre_bp2&quot;</span>: self.thre_bp2,\n            <span class=\"hljs-string\">&quot;thre_bp3&quot;</span>: self.thre_bp3,\n        }\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(save_path, <span class=\"hljs-string\">&quot;wb&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n            pickle.dump(model_dic, f)\n\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;Model saved： %s&quot;</span> % save_path)\n\n<span class=\"hljs-meta\">    @classmethod</span>\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">ReadModel</span>(<span class=\"hljs-params\">cls, model_path</span>):\n        <span class=\"hljs-comment\"># read saved model</span>\n        <span class=\"hljs-keyword\">with</span> <span class=\"hljs-built_in\">open</span>(model_path, <span class=\"hljs-string\">&quot;rb&quot;</span>) <span class=\"hljs-keyword\">as</span> f:\n            model_dic = pickle.load(f)\n\n        conv_get = model_dic.get(<span class=\"hljs-string\">&quot;conv1&quot;</span>)\n        conv_get.append(model_dic.get(<span class=\"hljs-string\">&quot;step_conv1&quot;</span>))\n        size_p1 = model_dic.get(<span class=\"hljs-string\">&quot;size_pooling1&quot;</span>)\n        bp1 = model_dic.get(<span class=\"hljs-string\">&quot;num_bp1&quot;</span>)\n        bp2 = model_dic.get(<span class=\"hljs-string\">&quot;num_bp2&quot;</span>)\n        bp3 = model_dic.get(<span class=\"hljs-string\">&quot;num_bp3&quot;</span>)\n        r_w = model_dic.get(<span class=\"hljs-string\">&quot;rate_weight&quot;</span>)\n        r_t = model_dic.get(<span class=\"hljs-string\">&quot;rate_thre&quot;</span>)\n        <span class=\"hljs-comment\"># create model instance</span>\n        conv_ins = CNN(conv_get, size_p1, bp1, bp2, bp3, r_w, r_t)\n        <span class=\"hljs-comment\"># modify model parameter</span>\n        conv_ins.w_conv1 = model_dic.get(<span class=\"hljs-string\">&quot;w_conv1&quot;</span>)\n        conv_ins.wkj = model_dic.get(<span class=\"hljs-string\">&quot;wkj&quot;</span>)\n        conv_ins.vji = model_dic.get(<span class=\"hljs-string\">&quot;vji&quot;</span>)\n        conv_ins.thre_conv1 = model_dic.get(<span class=\"hljs-string\">&quot;thre_conv1&quot;</span>)\n        conv_ins.thre_bp2 = model_dic.get(<span class=\"hljs-string\">&quot;thre_bp2&quot;</span>)\n        conv_ins.thre_bp3 = model_dic.get(<span class=\"hljs-string\">&quot;thre_bp3&quot;</span>)\n        <span class=\"hljs-keyword\">return</span> conv_ins\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">sig</span>(<span class=\"hljs-params\">self, x</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-number\">1</span> / (<span class=\"hljs-number\">1</span> + np.exp(-<span class=\"hljs-number\">1</span> * x))\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">do_round</span>(<span class=\"hljs-params\">self, x</span>):\n        <span class=\"hljs-keyword\">return</span> <span class=\"hljs-built_in\">round</span>(x, <span class=\"hljs-number\">3</span>)\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">convolute</span>(<span class=\"hljs-params\">self, data, convs, w_convs, thre_convs, conv_step</span>):\n        <span class=\"hljs-comment\"># convolution process</span>\n        size_conv = convs[<span class=\"hljs-number\">0</span>]\n        num_conv = convs[<span class=\"hljs-number\">1</span>]\n        size_data = np.shape(data)[<span class=\"hljs-number\">0</span>]\n        <span class=\"hljs-comment\"># get the data slice of original image data, data_focus</span>\n        data_focus = []\n        <span class=\"hljs-keyword\">for</span> i_focus <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">0</span>, size_data - size_conv + <span class=\"hljs-number\">1</span>, conv_step):\n            <span class=\"hljs-keyword\">for</span> j_focus <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">0</span>, size_data - size_conv + <span class=\"hljs-number\">1</span>, conv_step):\n                focus = data[\n                    i_focus : i_focus + size_conv, j_focus : j_focus + size_conv\n                ]\n                data_focus.append(focus)\n        <span class=\"hljs-comment\"># calculate the feature map of every single kernel, and saved as list of matrix</span>\n        data_featuremap = []\n        Size_FeatureMap = <span class=\"hljs-built_in\">int</span>((size_data - size_conv) / conv_step + <span class=\"hljs-number\">1</span>)\n        <span class=\"hljs-keyword\">for</span> i_map <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(num_conv):\n            featuremap = []\n            <span class=\"hljs-keyword\">for</span> i_focus <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(data_focus)):\n                net_focus = (\n                    np.<span class=\"hljs-built_in\">sum</span>(np.multiply(data_focus[i_focus], w_convs[i_map]))\n                    - thre_convs[i_map]\n                )\n                featuremap.append(self.sig(net_focus))\n            featuremap = np.asmatrix(featuremap).reshape(\n                Size_FeatureMap, Size_FeatureMap\n            )\n            data_featuremap.append(featuremap)\n\n        <span class=\"hljs-comment\"># expanding the data slice to One dimenssion</span>\n        focus1_list = []\n        <span class=\"hljs-keyword\">for</span> each_focus <span class=\"hljs-keyword\">in</span> data_focus:\n            focus1_list.extend(self.Expand_Mat(each_focus))\n        focus_list = np.asarray(focus1_list)\n        <span class=\"hljs-keyword\">return</span> focus_list, data_featuremap\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">pooling</span>(<span class=\"hljs-params\">self, featuremaps, size_pooling, <span class=\"hljs-built_in\">type</span>=<span class=\"hljs-string\">&quot;average_pool&quot;</span></span>):\n        <span class=\"hljs-comment\"># pooling process</span>\n        size_map = <span class=\"hljs-built_in\">len</span>(featuremaps[<span class=\"hljs-number\">0</span>])\n        size_pooled = <span class=\"hljs-built_in\">int</span>(size_map / size_pooling)\n        featuremap_pooled = []\n        <span class=\"hljs-keyword\">for</span> i_map <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(featuremaps)):\n            <span class=\"hljs-built_in\">map</span> = featuremaps[i_map]\n            map_pooled = []\n            <span class=\"hljs-keyword\">for</span> i_focus <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">0</span>, size_map, size_pooling):\n                <span class=\"hljs-keyword\">for</span> j_focus <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">0</span>, size_map, size_pooling):\n                    focus = <span class=\"hljs-built_in\">map</span>[\n                        i_focus : i_focus + size_pooling,\n                        j_focus : j_focus + size_pooling,\n                    ]\n                    <span class=\"hljs-keyword\">if</span> <span class=\"hljs-built_in\">type</span> == <span class=\"hljs-string\">&quot;average_pool&quot;</span>:\n                        <span class=\"hljs-comment\"># average pooling</span>\n                        map_pooled.append(np.average(focus))\n                    <span class=\"hljs-keyword\">elif</span> <span class=\"hljs-built_in\">type</span> == <span class=\"hljs-string\">&quot;max_pooling&quot;</span>:\n                        <span class=\"hljs-comment\"># max pooling</span>\n                        map_pooled.append(np.<span class=\"hljs-built_in\">max</span>(focus))\n            map_pooled = np.asmatrix(map_pooled).reshape(size_pooled, size_pooled)\n            featuremap_pooled.append(map_pooled)\n        <span class=\"hljs-keyword\">return</span> featuremap_pooled\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_expand</span>(<span class=\"hljs-params\">self, data</span>):\n        <span class=\"hljs-comment\"># expanding three dimension data to one dimension list</span>\n        data_expanded = []\n        <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(data)):\n            shapes = np.shape(data[i])\n            data_listed = data[i].reshape(<span class=\"hljs-number\">1</span>, shapes[<span class=\"hljs-number\">0</span>] * shapes[<span class=\"hljs-number\">1</span>])\n            data_listed = data_listed.getA().tolist()[<span class=\"hljs-number\">0</span>]\n            data_expanded.extend(data_listed)\n        data_expanded = np.asarray(data_expanded)\n        <span class=\"hljs-keyword\">return</span> data_expanded\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_expand_mat</span>(<span class=\"hljs-params\">self, data_mat</span>):\n        <span class=\"hljs-comment\"># expanding matrix to one dimension list</span>\n        data_mat = np.asarray(data_mat)\n        shapes = np.shape(data_mat)\n        data_expanded = data_mat.reshape(<span class=\"hljs-number\">1</span>, shapes[<span class=\"hljs-number\">0</span>] * shapes[<span class=\"hljs-number\">1</span>])\n        <span class=\"hljs-keyword\">return</span> data_expanded\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">_calculate_gradient_from_pool</span>(<span class=\"hljs-params\">\n        self, out_map, pd_pool, num_map, size_map, size_pooling\n    </span>):\n        <span class=\"hljs-string\">&quot;&quot;&quot;\n        calculate the gradient from the data slice of pool layer\n        pd_pool: list of matrix\n        out_map: the shape of data slice(size_map*size_map)\n        return: pd_all: list of matrix, [num, size_map, size_map]\n        &quot;&quot;&quot;</span>\n        pd_all = []\n        i_pool = <span class=\"hljs-number\">0</span>\n        <span class=\"hljs-keyword\">for</span> i_map <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(num_map):\n            pd_conv1 = np.ones((size_map, size_map))\n            <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">0</span>, size_map, size_pooling):\n                <span class=\"hljs-keyword\">for</span> j <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-number\">0</span>, size_map, size_pooling):\n                    pd_conv1[i : i + size_pooling, j : j + size_pooling] = pd_pool[\n                        i_pool\n                    ]\n                    i_pool = i_pool + <span class=\"hljs-number\">1</span>\n            pd_conv2 = np.multiply(\n                pd_conv1, np.multiply(out_map[i_map], (<span class=\"hljs-number\">1</span> - out_map[i_map]))\n            )\n            pd_all.append(pd_conv2)\n        <span class=\"hljs-keyword\">return</span> pd_all\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">train</span>(<span class=\"hljs-params\">\n        self, patterns, datas_train, datas_teach, n_repeat, error_accuracy, draw_e=<span class=\"hljs-built_in\">bool</span>\n    </span>):\n        <span class=\"hljs-comment\"># model traning</span>\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;----------------------Start Training-------------------------&quot;</span>)\n        <span class=\"hljs-built_in\">print</span>((<span class=\"hljs-string\">&quot; - - Shape: Train_Data  &quot;</span>, np.shape(datas_train)))\n        <span class=\"hljs-built_in\">print</span>((<span class=\"hljs-string\">&quot; - - Shape: Teach_Data  &quot;</span>, np.shape(datas_teach)))\n        rp = <span class=\"hljs-number\">0</span>\n        all_mse = []\n        mse = <span class=\"hljs-number\">10000</span>\n        <span class=\"hljs-keyword\">while</span> rp &lt; n_repeat <span class=\"hljs-keyword\">and</span> mse &gt;= error_accuracy:\n            error_count = <span class=\"hljs-number\">0</span>\n            <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;-------------Learning Time %d--------------&quot;</span> % rp)\n            <span class=\"hljs-keyword\">for</span> p <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(datas_train)):\n                <span class=\"hljs-comment\"># print(&#x27;------------Learning Image: %d--------------&#x27;%p)</span>\n                data_train = np.asmatrix(datas_train[p])\n                data_teach = np.asarray(datas_teach[p])\n                data_focus1, data_conved1 = self.convolute(\n                    data_train,\n                    self.conv1,\n                    self.w_conv1,\n                    self.thre_conv1,\n                    conv_step=self.step_conv1,\n                )\n                data_pooled1 = self.pooling(data_conved1, self.size_pooling1)\n                shape_featuremap1 = np.shape(data_conved1)\n                <span class=\"hljs-string\">&quot;&quot;&quot;\n                print(&#x27;  -----original shape   &#x27;, np.shape(data_train))\n                print(&#x27;  ---- after convolution  &#x27;,np.shape(data_conv1))\n                print(&#x27;  -----after pooling  &#x27;,np.shape(data_pooled1))\n               &quot;&quot;&quot;</span>\n                data_bp_input = self._expand(data_pooled1)\n                bp_out1 = data_bp_input\n\n                bp_net_j = np.dot(bp_out1, self.vji.T) - self.thre_bp2\n                bp_out2 = self.sig(bp_net_j)\n                bp_net_k = np.dot(bp_out2, self.wkj.T) - self.thre_bp3\n                bp_out3 = self.sig(bp_net_k)\n\n                <span class=\"hljs-comment\"># --------------Model Leaning ------------------------</span>\n                <span class=\"hljs-comment\"># calculate error and gradient---------------</span>\n                pd_k_all = np.multiply(\n                    (data_teach - bp_out3), np.multiply(bp_out3, (<span class=\"hljs-number\">1</span> - bp_out3))\n                )\n                pd_j_all = np.multiply(\n                    np.dot(pd_k_all, self.wkj), np.multiply(bp_out2, (<span class=\"hljs-number\">1</span> - bp_out2))\n                )\n                pd_i_all = np.dot(pd_j_all, self.vji)\n\n                pd_conv1_pooled = pd_i_all / (self.size_pooling1 * self.size_pooling1)\n                pd_conv1_pooled = pd_conv1_pooled.T.getA().tolist()\n                pd_conv1_all = self._calculate_gradient_from_pool(\n                    data_conved1,\n                    pd_conv1_pooled,\n                    shape_featuremap1[<span class=\"hljs-number\">0</span>],\n                    shape_featuremap1[<span class=\"hljs-number\">1</span>],\n                    self.size_pooling1,\n                )\n                <span class=\"hljs-comment\"># weight and threshold learning process---------</span>\n                <span class=\"hljs-comment\"># convolution layer</span>\n                <span class=\"hljs-keyword\">for</span> k_conv <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(self.conv1[<span class=\"hljs-number\">1</span>]):\n                    pd_conv_list = self._expand_mat(pd_conv1_all[k_conv])\n                    delta_w = self.rate_weight * np.dot(pd_conv_list, data_focus1)\n\n                    self.w_conv1[k_conv] = self.w_conv1[k_conv] + delta_w.reshape(\n                        (self.conv1[<span class=\"hljs-number\">0</span>], self.conv1[<span class=\"hljs-number\">0</span>])\n                    )\n\n                    self.thre_conv1[k_conv] = (\n                        self.thre_conv1[k_conv]\n                        - np.<span class=\"hljs-built_in\">sum</span>(pd_conv1_all[k_conv]) * self.rate_thre\n                    )\n                <span class=\"hljs-comment\"># all connected layer</span>\n                self.wkj = self.wkj + pd_k_all.T * bp_out2 * self.rate_weight\n                self.vji = self.vji + pd_j_all.T * bp_out1 * self.rate_weight\n                self.thre_bp3 = self.thre_bp3 - pd_k_all * self.rate_thre\n                self.thre_bp2 = self.thre_bp2 - pd_j_all * self.rate_thre\n                <span class=\"hljs-comment\"># calculate the sum error of all single image</span>\n                errors = np.<span class=\"hljs-built_in\">sum</span>(<span class=\"hljs-built_in\">abs</span>(data_teach - bp_out3))\n                error_count += errors\n                <span class=\"hljs-comment\"># print(&#x27;   ----Teach      &#x27;,data_teach)</span>\n                <span class=\"hljs-comment\"># print(&#x27;   ----BP_output  &#x27;,bp_out3)</span>\n            rp = rp + <span class=\"hljs-number\">1</span>\n            mse = error_count / patterns\n            all_mse.append(mse)\n\n        <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">draw_error</span>():\n            yplot = [error_accuracy <span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">int</span>(n_repeat * <span class=\"hljs-number\">1.2</span>))]\n            plt.plot(all_mse, <span class=\"hljs-string\">&quot;+-&quot;</span>)\n            plt.plot(yplot, <span class=\"hljs-string\">&quot;r--&quot;</span>)\n            plt.xlabel(<span class=\"hljs-string\">&quot;Learning Times&quot;</span>)\n            plt.ylabel(<span class=\"hljs-string\">&quot;All_mse&quot;</span>)\n            plt.grid(<span class=\"hljs-literal\">True</span>, alpha=<span class=\"hljs-number\">0.5</span>)\n            plt.show()\n\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;------------------Training Complished---------------------&quot;</span>)\n        <span class=\"hljs-built_in\">print</span>((<span class=\"hljs-string\">&quot; - - Training epoch: &quot;</span>, rp, <span class=\"hljs-string\">&quot;     - - Mse: %.6f&quot;</span> % mse))\n        <span class=\"hljs-keyword\">if</span> draw_e:\n            draw_error()\n        <span class=\"hljs-keyword\">return</span> mse\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">predict</span>(<span class=\"hljs-params\">self, datas_test</span>):\n        <span class=\"hljs-comment\"># model predict</span>\n        produce_out = []\n        <span class=\"hljs-built_in\">print</span>(<span class=\"hljs-string\">&quot;-------------------Start Testing-------------------------&quot;</span>)\n        <span class=\"hljs-built_in\">print</span>((<span class=\"hljs-string\">&quot; - - Shape: Test_Data  &quot;</span>, np.shape(datas_test)))\n        <span class=\"hljs-keyword\">for</span> p <span class=\"hljs-keyword\">in</span> <span class=\"hljs-built_in\">range</span>(<span class=\"hljs-built_in\">len</span>(datas_test)):\n            data_test = np.asmatrix(datas_test[p])\n            data_focus1, data_conved1 = self.convolute(\n                data_test,\n                self.conv1,\n                self.w_conv1,\n                self.thre_conv1,\n                conv_step=self.step_conv1,\n            )\n            data_pooled1 = self.pooling(data_conved1, self.size_pooling1)\n            data_bp_input = self._expand(data_pooled1)\n\n            bp_out1 = data_bp_input\n            bp_net_j = bp_out1 * self.vji.T - self.thre_bp2\n            bp_out2 = self.sig(bp_net_j)\n            bp_net_k = bp_out2 * self.wkj.T - self.thre_bp3\n            bp_out3 = self.sig(bp_net_k)\n            produce_out.extend(bp_out3.getA().tolist())\n        res = [<span class=\"hljs-built_in\">list</span>(<span class=\"hljs-built_in\">map</span>(self.do_round, each)) <span class=\"hljs-keyword\">for</span> each <span class=\"hljs-keyword\">in</span> produce_out]\n        <span class=\"hljs-keyword\">return</span> np.asarray(res)\n\n    <span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">convolution</span>(<span class=\"hljs-params\">self, data</span>):\n        <span class=\"hljs-comment\"># return the data of image after convoluting process so we can check it out</span>\n        data_test = np.asmatrix(data)\n        data_focus1, data_conved1 = self.convolute(\n            data_test,\n            self.conv1,\n            self.w_conv1,\n            self.thre_conv1,\n            conv_step=self.step_conv1,\n        )\n        data_pooled1 = self.pooling(data_conved1, self.size_pooling1)\n\n        <span class=\"hljs-keyword\">return</span> data_conved1, data_pooled1\n\n\n<span class=\"hljs-keyword\">if</span> __name__ == <span class=\"hljs-string\">&quot;__main__&quot;</span>:\n    <span class=\"hljs-string\">&quot;&quot;&quot;\n    I will put the example on other file\n    &quot;&quot;&quot;</span>\n"
    }
  },
  "contributors": [
    {
      "name": "AlexDvorak",
      "email": "opti.jawsome@gmail.com",
      "commits": 1
    },
    {
      "name": "William Zhang",
      "email": "39932068+WilliamHYZhang@users.noreply.github.com",
      "commits": 1
    },
    {
      "name": "Denis Trofimov",
      "email": "silaradost@yandex.ru",
      "commits": 1
    },
    {
      "name": "cedricfarinazzo",
      "email": "cedric.farinazzo@gmail.com",
      "commits": 1
    },
    {
      "name": "cclauss",
      "email": "cclauss@bluewin.ch",
      "commits": 1
    },
    {
      "name": "97arushisharma",
      "email": "97arushisharma@gmail.com",
      "commits": 1
    },
    {
      "name": "RiptideBo",
      "email": "245885195@qq.com",
      "commits": 2
    },
    {
      "name": "Christian Clauss",
      "email": "cclauss@me.com",
      "commits": 4
    }
  ],
  "explanationUrl": {}
}
